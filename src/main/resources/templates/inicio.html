<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="head.html"> </head>
<style>
h2{
 color: #343a40;
}
</style>
<body>
	 <div class="wrapper" style="height: 100%;">
        <!-- Sidebar  -->
        <nav th:replace="sidebar.html"> </nav>
        <!-- Sidebar  -->
        <!-- Page Content  -->
        <div id="wrapper" style="width: 100%;position: absolute;height: 100%;">
	    	<div class="pos-f-t">
	            <nav class="navbar navbar-dark mb-0" th:classappend="${theme=='dark'} ? bg-dark : 'bg-light'">
	            	<div class="col-3 col-md-4">
	            		<button type="button" id="loadFile" class="btn float-left" th:classappend="${theme=='dark'} ? btn-dark : btn-light" th:text="#{button.open}"></button>
	            	</div>
					<div class="col-6 col-md-4 text-center">
						<span class="" th:classappend="${theme=='dark'} ? text-light : text-dark">DBCASE WEB</span>
					</div>
					<div class="col-3 col-md-4 text-right">
						<div>
	             			<div class="dropdown">
								<img th:attr="src=${perfil.userAuthentication.Details.picture},alt=${perfil.userAuthentication.Details.given_name}" class="dropdown-toggle rounded-circle" width="50" height="50" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">  
								<div class="dropdown-menu" th:classappend="${theme=='dark'} ? bg-dark : bg-light" aria-labelledby="dropdownMenuButton" style="left: unset;right: 0;z-index: 1000000;">
								    <a class="dropdown-item text-center" th:classappend="${theme=='dark'} ? text-light : text-dark" th:text="#{general.saludo}+' '+ ${perfil.userAuthentication.Details.given_name}" ></a>
								    <a class="dropdown-item text-center" th:classappend="${theme=='dark'} ? text-light : text-dark" href="/logout" th:text="#{general.logout}"></a>
								    <div class="dropdown-divider"></div>
								    <a id="dropdownMenuLanguage" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-item dropdown-toggle text-center" th:classappend="${theme=='dark'} ? text-light : text-dark" th:text="#{general.configuration}"></a>
						              <ul aria-labelledby="dropdownMenuLanguage" class="dropdown-menu border-0 shadow" th:classappend="${theme=='dark'} ? bg-dark : bg-light" style="left: 17px;">
						              	<h6 class="dropdown-header text-center" th:classappend="${theme=='dark'} ? text-light : text-dark" th:text="#{general.theme}"></h6>
						                <li><a href="/lang?lang=es" class="changeOptions dropdown-item text-white" th:classappend="${language=='es'} ? (${theme=='dark'} ? 'text-light active' : 'active text-dark') : (${theme=='dark'} ? 'text-light' : 'text-dark')" th:text="#{general.es}"></a></li>
						                <li><a href="/lang?lang=en" class="changeOptions dropdown-item text-white" th:classappend="${language=='en'} ? (${theme=='dark'} ? 'text-light active' : 'active text-dark') : (${theme=='dark'} ? 'text-light' : 'text-dark')" th:text="#{general.en}"></a></li>
						                <div class="dropdown-divider"></div>
						                <h6 class="dropdown-header text-center" th:classappend="${theme=='dark'} ? text-light : text-dark" th:text="#{general.language}"></h6>
						                <li><a href="/theme?theme=dark" class="changeOptions dropdown-item text-white" th:classappend="${theme=='dark'} ? active : 'text-dark'" th:text="#{general.dark}"></a></li>
						                <li><a href="/theme?theme=light" class="changeOptions dropdown-item text-white" th:classappend="${theme=='light'} ? active : 'text-light'" th:text="#{general.light}"></a></li>
						              </ul>
								</div>
							</div>
	             		</div>
	             	</div>
	            </nav>
	         </div>
          	<div  style="height: 87.27%;">
				<div class="row mr-0 changeSizeHeight col-md-6-height">
				  <div class="col-md-6 changeSizeWidth col-md-12-height overflow-auto" th:classappend="${theme=='dark'} ? 'text-white bg-dark' : 'text-dark bg-light'">
					<div id="diagram" class="w-100 h-100">
					</div>
					<button type="button" id="sidebarCollapse" class="btn" th:classappend="${theme=='dark'} ? btn-dark : btn-light" style="position: absolute;top: 0px;left: 15px;z-index: 10000;">
                        <span style="writing-mode: vertical-rl;text-orientation: upright;line-height: 0px;font-size: 12px;letter-spacing: -3px;" th:text="#{add.items}"></span>
                    </button>
                  </div>
				  <div class="col-md-6 changeSizeWidth paddingLeft col-md-12-height overflow-auto" th:classappend="${theme=='dark'} ? 'text-white bg-dark' : 'text-dark bg-light'">
					  	<div class="row pt-2 sticky-top" th:classappend="${theme=='dark'} ? bg-dark : bg-light">
						  <div class="col-6 col-md-6"><p class="h5 mt-2" th:classappend="${theme=='dark'} ? 'text-white' : 'text-dark'" th:text="#{textos.logicalSchema}"></p></div>
						  <div class="col-6 col-md-6"><button id="saveAs" type="button" class="btn float-right ml-2" th:classappend="${theme=='dark'} ? btn-dark : btn-light" th:text="#{button.saveAs}"></button><button type="button" id="btnTest" class="btn float-right" th:classappend="${theme=='dark'} ? btn-dark : btn-light" th:text="#{button.generate}"></button></div>
						</div>
						<div class="w-100" id="testResult">
						</div>
				  </div>
				</div>
				<div class="row mr-0" style="height: 50%;">
				  <div class="col-md-6">.col-12 .col-md-8</div>
				  <div class="col-md-6">.col-6 .col-md-4</div>
				</div>
			</div>
            <div th:replace="footer.html"> </div>
        </div>
    </div>
    <!-- Bootstrap JS -->
    <script type="text/javascript">
        $(document).ready(function () {
        	
       	 	 $('#btnTest').on('click', function () {
       		  //var url = "<c:url value="/generateData"/>";
       		  var f= 2;
       		  var myObj = {}; 
              myObj["data1"] = JSON.stringify(nodes.get()); 
              myObj["data2"] = JSON.stringify(edges.get()); 
              var json = JSON.stringify(myObj);
                
       		  $.ajax({
                     type: 'POST',
                     url: '/generateData',
                     data: json,
                     contentType: "application/json",
                     success: function (data) {
                         console.log("respuesta valida");
                         $("#testResult").html(data);
                     },
                     error: function (xhr, ajaxOptions, thrownError) {
                         console.log(xhr.status);
                         console.log(xhr.responseText);
                         console.log(thrownError);
                     }

                 });
            });
        	
        	 $('.vis-zoomExtends').on('click', function () {
        		 $('.changeSizeWidth').toggleClass('col-md-6');
                 $('.changeSizeWidth').toggleClass('col-md-12');
                 $('.changeSizeWidth').toggleClass('col-md-6-height');
                 $('.changeSizeWidth').toggleClass('col-md-12-height');
                 $('.changeSizeHeight').toggleClass('col-md-6-height');
                 $('.changeSizeHeight').toggleClass('col-md-24-height');
             });
        	 
     //       $('#sidebarCollapse, .closeSide').on('click', function () {
    	 	$('#sidebarCollapse').on('click', function () {
                $('#sidebar').toggleClass('active');
            });
            
            $('.closeSide').on('click', function() {
                $('#titleModal').html(this.getAttribute("alt"));
                $('#tipoAdd').val(this.getAttribute("functionInsert"));
             //   $('#sidebar').removeClass('active');
            });
            
            $('#addIsA').on('click', function() {
            	addIsA();
            });
      
            $('#insertModal').on('click', function() {         
            	switch($('#tipoAdd').val()) {
	            	case "addConstrainst":
	            		addConstrainst($('input[name=listText\\[\\]]').serializeArray(),$('#idSelected').val(), $('#typeAction').val());
		          	    break;
		          	case "addEntity":
		          		addEntity($('#recipient-name').val(), $('#weak-entity').prop('checked'),$('#typeAction').val(),$('#idSelected').val());
		          	    break;
		          	case "addRelation":
		          		console.log($('#recipient-name').val()+" "+$('#typeAction').val()+" "+$('#idSelected').val());
		          		addRelation($('#recipient-name').val(),$('#typeAction').val(),$('#idSelected').val());
		          	    break;
		          	case "addAttribute":
		          		addAttribute($('#recipient-name').val(),$('#typeAction').val(),$('#idSelected').val(), $('#element').val(), $('#primaryKey').prop('checked'), $('#composite').prop('checked'), $('#notNull').prop('checked'), $('#unique').prop('checked'), $('#multivalued').prop('checked'), $('#domain').val(), $('#size').val());
		            	break;
		          	case "addEntitytoRelation":
		          		addEntitytoRelation($('#element').val(), $('[name=cardinality]:checked').val(), $('#roleName').val(), $('#minCardinality').val(), $('#maxCardinality').val(), $('#typeAction').val(),$('#idSelected').val());
		            	break;
		          	case "removeEntitytoRelation":
		          		removeEntitytoRelation($('#element').val(), $('#typeAction').val(),$('#idSelected').val());
		            	break;
		          	case "addDomain":
		          		addTypeDomain($('#recipient-name').val(), $('#types').val(), $('#values_separated').val(), $('#typeAction').val());
		            	break;
		          	case "addTableUnique":
		          		addTableUnique(groupByArray($('#formInsert').serializeArray()),$('#idSelected').val(), $('#typeAction').val());
		            	break;	
		          	case "addIsA":
		            	break;
		          	  default:
		          	}
            	//clean();
            });
            
            $('.insertarDatos').on('click', function() {
            	var insert = ""
            	var nodo_select = getNodeSelected();
            	switch($(this).attr("functionInsert")) {
            	  case "addConstrainst":
            		  var dataType = {
            			  temp_node_select: nodo_select
            			};
            		  $('#formModal').html($('#templateAddConstrainst').tmpl(dataType));
            	    break;
            	  case "addEntity":
            		  var dataType = {
            				temp_node_select: nodo_select
            			};
            		  $('#formModal').html($('#templateAddEntity').tmpl(dataType));
            	    break;
            	  case "addRelation":
            		  var dataType = {
          					temp_node_select: nodo_select
          			  };
          		  	  $('#formModal').html($('#templateAddRelation').tmpl(dataType));
            	    break;
            	  case "addAtribute":
            		  nodo = getAllNodes(["box","diamond"]);
            		  types = getAllTypesDomain();
            		  
            		  var dataType = {
            				temp_node_length: nodo.length,
            				temp_nodes: nodo,
            				temp_types: types,
           					temp_node_select: nodo_select,
           					temp_type_item: getTypeItem(nodo_select)
           			  };
            		  
            		  $('#formModal').html($('#templateAddAtribute').tmpl(dataType));
              	    break;
            	  case "addEntitytoRelation":
            		  nodo = getAllNodes(["box"]);
            		  var dataType = {
              				temp_node_length: nodo.length,
              				temp_nodes: nodo,
             				temp_node_select: nodo_select
             			  };
              		  
              		  $('#formModal').html($('#templateAddEntitytoRelation').tmpl(dataType));
              		  
              	    break;
            	  case "removeEntitytoRelation":
            		  nodo = allEntitysToRelation(nodo_select);
            		  var dataType = {
                				temp_node_length: nodo.length,
                				temp_nodes: nodo,
               					temp_node_select: nodo_select
               			  };
                		  
                	  $('#formModal').html($('#templateRemoveEntitytoRelation').tmpl(dataType));
              	    break;
            	  case "createDomain":
            		  	types = getAllTypesDomain();
            		  	var dataType = {
            				  	temp_types: types,
	           				  	temp_node_select: nodo_select
             			};
 
              	  	  $('#formModal').html($('#templateCreateDomain').tmpl(dataType));
              	    break;
            	  	case "addUniqueKey":
            	  		nodo = allAttributeOfEntity(nodo_select);
            	  		var dataType = {
           	  				temp_node_length: nodo.length,
               				temp_nodes: nodo,
              				temp_node_select: nodo_select
             			};
            	  		$('#formModal').html($('#templateAddUniqueKey').tmpl(dataType));
            	  		$('.select-multiple').select2();
            	  		
            	  		$(".select-multiple").change(function() {				            		
            	  			$('#insertModal').prop('disabled', false);
                   		});
            	    break;
            	  	case "downloadFile":
            	  		var dataType = {
              					temp_node_select: nodo_select
              			  };
              		  	  $('#formModal').html($('#templateDownloadFile').tmpl(dataType));
            	    break;
            	  	case "loadFile":
            	  		var dataType = {
          					temp_node_select: nodo_select
          			  };
          		  	  $('#formModal').html($('#templateAddLoadFile').tmpl(dataType));
      	    		break;
            	  default:
            	}
            	setNodeSelected(null);
            	//** hacer aqui que vuelva aparcer los botones
            	$('#modalAddItem').on('hide.bs.modal', function (event) {            	
            		$("#formModalButton").show();
            		$('#sidebar').removeClass('active');
            	});
            	
            	$('#modalAddItem').on('hidden.bs.modal', function (event) {
            		console.log("limpiar model");
            		$('#formModal').html("");
            	});
            	
            	switch($(this).attr("functionInsert")) {
            		case "addEntitytoRelation":
            			eventsEntityToRelation();
            		break;
            		case "removeEntitytoRelation":
            			eventsRemoveEntityToRelation();
            		break;
              	 	default:
            	}
            	editList();
            	$("#primaryKey, #composite").change(function() {
            		if(($("#primaryKey").prop('checked') && $("#composite").prop('checked')) || 
            		   ($("#primaryKey").prop('checked') && !$("#composite").prop('checked'))){
            			$("[for='notNull'],[for='unique'],[for='multivalued']").toggle(false);            			
            		}
					if(!$("#primaryKey").prop('checked') && $("#composite").prop('checked')){
						$("[for='notNull'],[for='unique']").toggle(false);
						$("[for='multivalued']").toggle(true);
					}
					if(!$("#primaryKey").prop('checked') && !$("#composite").prop('checked')){
						$("[for='notNull'],[for='unique'],[for='multivalued']").toggle(true);  
					}						            		
           		});
            	
            	/*
            	Verifica que el campo no añada elementos con nombre de campos repetidos
            	*/
            	$( "#recipient-name" ).on( "blur keyup", function(){
            		  var nameValue = $( "#recipient-name" ).val();
            		  var tipoAdd = $( "#tipoAdd" ).val();
           			  if(!existElementName(nameValue, tipoAdd)){
            			  $('#insertModal').prop('disabled', false);
            			  $( "#recipient-name" ).removeClass("is-invalid");
           			  }else{
           				  $('#insertModal').prop('disabled', true);
           				  $( "#recipient-name" ).addClass("is-invalid");
           			  }
            	});
            	/*
            	Verifica que el campo de restriccion no este vacio
            	*/
            	$( "#list0" ).on( "blur keyup", function(){
          			var nameValue = $( "#list0" ).val();
         			if(nameValue == ""){
          				$('#insertModal').prop('disabled', true);
         			}else{
         				$('#insertModal').prop('disabled', false);
         			}
          		});
            	
            	$( ".insertarDatos" ).click(function() {
            		$('#insertModal').prop('disabled', true);
          		});
            });
        });
    </script>
<!-- Modal -->
<div class="modal fade" id="modalAddItem" tabindex="-1" role="dialog" style="z-index: 10001;" aria-labelledby="modalAddItemTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="titleModal"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="formModal">
        
      </div>
      <div class="modal-footer" id="formModalButton">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal" id="insertModal" disabled>Insert</button>
      </div>
    </div>
  </div>
</div>
<div th:replace="textJS.html"> </div>
<div th:replace="templatesModal.html"> </div>
</body>
</html>